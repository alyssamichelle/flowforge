<!-- Workflow Composer Application -->
<div class="workflow-composer">
  <!-- Header -->
  <header class="app-header">
    <h1 class="app-title">{{ title() }}</h1>
    <div class="app-actions">
      <button kendoButton [themeColor]="'primary'">Save Workflow</button>
      <button kendoButton>Run</button>
    </div>
  </header>

  <!-- Main Layout with Splitter -->
  <kendo-splitter
    class="workflow-splitter"
    [orientation]="'horizontal'"
  >
    <!-- Left Sidebar: Available Workflow Steps -->
    <kendo-splitter-pane
      [size]="'250px'"
      [min]="'200px'"
      [max]="'400px'"
      [collapsible]="true"
    >
      <div class="sidebar-panel left-panel">
        <div class="panel-header">
          <h2>Workflow Steps</h2>
        </div>
        <div class="panel-content">
          @for (step of availableSteps(); track step.id) {
            <div 
              kendoDragTarget
              [dragData]="getDragData(step)"
              (press)="onDragPress($event)"
              (release)="onDragRelease($event)"
              class="drag-wrapper"
              role="button"
              tabindex="0"
              [attr.aria-label]="step.ariaLabel"
              [attr.aria-describedby]="'step-desc-' + step.id"
            >
              <kendo-card class="step-card">
                <kendo-card-header>
                  <div class="step-card-header">
                    <kendo-svg-icon 
                      [icon]="step.svgIcon" 
                      class="step-icon"
                      [attr.aria-hidden]="true"
                    ></kendo-svg-icon>
                    <h3 kendoCardTitle>{{ step.name }}</h3>
                  </div>
                </kendo-card-header>
                <kendo-card-body>
                  <p class="step-description" [id]="'step-desc-' + step.id">
                    {{ step.description }}
                  </p>
                </kendo-card-body>
              </kendo-card>
            </div>
          }
        </div>
      </div>
    </kendo-splitter-pane>

    <!-- Center Canvas: Workflow Builder -->
    <kendo-splitter-pane [resizable]="true">
      <div class="canvas-panel">
        <div class="panel-header">
          <h2>Workflow Canvas</h2>
          <div class="canvas-controls">
            <button kendoButton [icon]="'zoom-in'" [fillMode]="'flat'"></button>
            <button kendoButton [icon]="'zoom-out'" [fillMode]="'flat'"></button>
            <button kendoButton [icon]="'reset'" [fillMode]="'flat'"></button>
          </div>
        </div>
        <div 
          class="panel-content canvas-content"
          kendoDropTarget
          kendoDragTargetContainer
          [dragTargetFilter]="'.canvas-step'"
          [dragHandle]="'.canvas-step-name'"
          [mode]="'manual'"
          (enter)="onDragEnter()"
          (leave)="onDragLeave()"
          (drop)="onDrop($event)"
          (onDragStart)="onCanvasStepDragStart($event)"
          (onDrag)="onCanvasStepDrag($event)"
          (onDragEnd)="onCanvasStepDragEnd($event)"
          (click)="cancelConnection()"
          [class.drag-over]="isDraggingOver()"
          [class.connecting-mode]="connectingFrom()"
        >
          <!-- SVG layer for connections -->
          <svg class="connections-layer" aria-hidden="true">
            <defs>
              <!-- Arrow marker for connection lines -->
              <marker
                id="arrowhead"
                markerWidth="10"
                markerHeight="10"
                refX="9"
                refY="3"
                orient="auto"
              >
                <polygon points="0 0, 10 3, 0 6" fill="var(--kendo-color-primary, #0078d4)" />
              </marker>
            </defs>
            
            <!-- Draw connection lines -->
            @for (connection of connections(); track connection.id) {
              <g class="connection-group">
                <path
                  [attr.d]="getConnectionPath(connection)"
                  class="connection-line"
                  stroke="var(--kendo-color-primary, #0078d4)"
                  stroke-width="2"
                  fill="none"
                  marker-end="url(#arrowhead)"
                />
                <!-- Invisible wider path for easier clicking -->
                <path
                  [attr.d]="getConnectionPath(connection)"
                  class="connection-hitarea"
                  stroke="transparent"
                  stroke-width="12"
                  fill="none"
                  (click)="deleteConnection(connection, $event)"
                  [attr.aria-label]="'Delete connection. Click to remove.'"
                  role="button"
                  tabindex="0"
                />
              </g>
            }
          </svg>

          @if (canvasSteps().length === 0) {
            <div class="canvas-placeholder">
              <svg class="placeholder-icon" width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <p class="placeholder-text">Drag workflow steps here to start building your flow</p>
            </div>
          }

          @for (canvasStep of canvasSteps(); track canvasStep.id) {
            <div 
              class="canvas-step"
              [class.selected]="selectedStep()?.id === canvasStep.id"
              [class.connecting]="connectingFrom() && connectingFrom()?.id !== canvasStep.id"
              [class.connecting-source]="connectingFrom()?.id === canvasStep.id"
              [style.left.px]="canvasStep.x - 75"
              [style.top.px]="canvasStep.y - 50"
              (click)="connectingFrom() ? completeConnection(canvasStep, $event) : selectCanvasStep(canvasStep)"
              (mouseenter)="onStepMouseEnter(canvasStep)"
              (mouseleave)="onStepMouseLeave()"
              role="button"
              tabindex="0"
              [attr.aria-label]="'Workflow step: ' + canvasStep.name + '. Click to select and edit properties.'"
            >
              <!-- Connection indicator when in connecting mode -->
              @if (connectingFrom() && connectingFrom()?.id !== canvasStep.id) {
                <div class="connection-indicator" aria-hidden="true"></div>
              }
              
              <div class="canvas-step-header">
                <kendo-svg-icon 
                  [icon]="canvasStep.svgIcon" 
                  class="canvas-step-icon"
                  [attr.aria-hidden]="true"
                ></kendo-svg-icon>
                <span class="canvas-step-name">{{ canvasStep.name }}</span>
                
                <!-- Action buttons -->
                <div class="step-actions">
                  <button 
                    kendoButton 
                    [icon]="'link-45'"
                    [fillMode]="'flat'"
                    [size]="'small'"
                    class="connect-btn"
                    [attr.aria-label]="'Connect ' + canvasStep.name + ' to another step'"
                    (click)="startConnection(canvasStep, $event)"
                    title="Connect to another step"
                  ></button>
                  <button 
                    kendoButton 
                    [icon]="'x'" 
                    [fillMode]="'flat'"
                    [size]="'small'"
                    class="remove-btn"
                    [attr.aria-label]="'Remove ' + canvasStep.name + ' from workflow'"
                    (click)="removeCanvasStep(canvasStep); $event.stopPropagation()"
                    title="Remove step"
                  ></button>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </kendo-splitter-pane>

    <!-- Right Panel: Step Details/Properties -->
    <kendo-splitter-pane
      [size]="'300px'"
      [min]="'250px'"
      [max]="'500px'"
      [collapsible]="true"
    >
      <div class="sidebar-panel right-panel">
        <div class="panel-header">
          <h2>Properties</h2>
        </div>
        <div class="panel-content">
          @if (selectedStep()) {
            <kendo-card class="properties-card">
              <kendo-card-header>
                <h3 kendoCardTitle>{{ selectedStep()?.name }}</h3>
              </kendo-card-header>
              <kendo-card-body>
                <div class="property-group">
                  <label class="property-label">Name</label>
                  <input type="text" class="k-input k-input-solid" [value]="selectedStep()?.name" />
                </div>
                <div class="property-group">
                  <label class="property-label">Description</label>
                  <textarea class="k-textarea k-input-solid" rows="3">{{ selectedStep()?.description }}</textarea>
                </div>
                <div class="property-group">
                  <label class="property-label">Type</label>
                  <input type="text" class="k-input k-input-solid" [value]="selectedStep()?.type" readonly />
                </div>
              </kendo-card-body>
              <kendo-card-actions [orientation]="'horizontal'">
                <button kendoButton [themeColor]="'primary'">Apply</button>
                <button kendoButton>Cancel</button>
              </kendo-card-actions>
            </kendo-card>
          } @else {
            <div class="empty-state">
              <p>Select a workflow step to view its properties</p>
            </div>
          }
        </div>
      </div>
    </kendo-splitter-pane>
  </kendo-splitter>
</div>
